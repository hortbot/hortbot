package eventsub_test

import (
	"encoding/json"
	"strconv"
	"testing"

	"github.com/hortbot/hortbot/internal/pkg/apiclient/twitch/eventsub"
	"gotest.tools/v3/assert"
)

func TestUnmarshalBroken(t *testing.T) {
	t.Parallel()
	tests := []string{
		"{\"metadata\":{\"message_id\":\"epaiOzTgQgKN_us5Wc2QMoxABftosfv-PdEydoAQ0wM=\",\"message_type\":\"notification\",\"message_timestamp\":\"2024-05-22T17:52:11.048754237Z\",\"subscription_type\":\"channel.chat.message\",\"subscription_version\":\"1\"},\"payload\":{\"subscription\":{\"id\":\"073c30f8-dffc-4e90-a140-689cfa1cac43\",\"status\":\"enabled\",\"type\":\"channel.chat.message\",\"version\":\"1\",\"condition\":{\"broadcaster_user_id\":\"39392583\",\"user_id\":\"55056264\"},\"transport\":{\"method\":\"conduit\",\"conduit_id\":\"896f2a0e-5ba9-430c-87ff-edfca4850479\"},\"created_at\":\"2024-05-22T17:15:00.633267495Z\",\"cost\":0},\"event\":{\"broadcaster_user_id\":\"39392583\",\"broadcaster_user_login\":\"ryuquezacotl\",\"broadcaster_user_name\":\"RyuQuezacotl\",\"chatter_user_id\":\"65628971\",\"chatter_user_login\":\"stefandiewaldfee\",\"chatter_user_name\":\"StefanDieWaldfee\",\"message_id\":\"37eeeb2f-7456-4cdc-9842-9c9aed3c29c9\",\"message\":{\"text\":\"i believe in you ryu!\",\"fragments\":[{\"type\":\"text\",\"text\":\"i believe in you ryu!\",\"cheermote\":null,\"emote\":null,\"mention\":null}]},\"color\":\"#8A2BE2\",\"badges\":[{\"set_id\":\"predictions\",\"id\":\"pink-2\",\"info\":\"no\"},{\"set_id\":\"subscriber\",\"id\":\"0\",\"info\":\"1\"},{\"set_id\":\"glitchcon2020\",\"id\":\"1\",\"info\":\"\"}],\"message_type\":\"text\",\"cheer\":null,\"reply\":null,\"channel_points_custom_reward_id\":null,\"channel_points_animation_id\":null}}}",
		"{\"metadata\":{\"message_id\":\"JIHE-SmoEJJvRapt3OPpEb6Iq1gcM_kl3rMTuFCebbM=\",\"message_type\":\"notification\",\"message_timestamp\":\"2024-05-22T20:44:10.044186211Z\",\"subscription_type\":\"channel.chat.message\",\"subscription_version\":\"1\"},\"payload\":{\"subscription\":{\"id\":\"5c32f8d4-163d-4200-bfff-043b55a5ef9c\",\"status\":\"enabled\",\"type\":\"channel.chat.message\",\"version\":\"1\",\"condition\":{\"broadcaster_user_id\":\"22186976\",\"user_id\":\"55056264\"},\"transport\":{\"method\":\"conduit\",\"conduit_id\":\"896f2a0e-5ba9-430c-87ff-edfca4850479\"},\"created_at\":\"2024-05-22T17:14:35.330453713Z\",\"cost\":0},\"event\":{\"broadcaster_user_id\":\"22186976\",\"broadcaster_user_login\":\"hcjustin\",\"broadcaster_user_name\":\"HCJustin\",\"chatter_user_id\":\"55056264\",\"chatter_user_login\":\"coebot\",\"chatter_user_name\":\"CoeBot\",\"message_id\":\"8017b008-4a83-4c79-a7bc-b13ebafd4573\",\"message\":{\"text\":\"coebotBot Join the Slub Club TODAY  hcjHH  and get a FREE GUN  hcjGun  http://subs.twitch.tv/hcjustin\",\"fragments\":[{\"type\":\"emote\",\"text\":\"coebotBot\",\"cheermote\":null,\"emote\":{\"id\":\"793340\",\"emote_set_id\":\"580501\",\"owner_id\":\"55056264\",\"format\":[\"static\"]},\"mention\":null},{\"type\":\"text\",\"text\":\" Join the Slub Club TODAY  \",\"cheermote\":null,\"emote\":null,\"mention\":null},{\"type\":\"emote\",\"text\":\"hcjHH\",\"cheermote\":null,\"emote\":{\"id\":\"1205505\",\"emote_set_id\":\"7351\",\"owner_id\":\"22186976\",\"format\":[\"static\"]},\"mention\":null},{\"type\":\"text\",\"text\":\"  and get a FREE GUN  \",\"cheermote\":null,\"emote\":null,\"mention\":null},{\"type\":\"emote\",\"text\":\"hcjGun\",\"cheermote\":null,\"emote\":{\"id\":\"emotesv2_e8ce8ec84c0c4d29b1d9bbf1b3c74c60\",\"emote_set_id\":\"7351\",\"owner_id\":\"22186976\",\"format\":[\"static\"]},\"mention\":null},{\"type\":\"text\",\"text\":\"  http://subs.twitch.tv/hcjustin\",\"cheermote\":null,\"emote\":null,\"mention\":null}]},\"color\":\"#2E8B57\",\"badges\":[{\"set_id\":\"moderator\",\"id\":\"1\",\"info\":\"\"},{\"set_id\":\"founder\",\"id\":\"0\",\"info\":\"117\"}],\"message_type\":\"text\",\"cheer\":null,\"reply\":null,\"channel_points_custom_reward_id\":null,\"channel_points_animation_id\":null}}}",
		"{\"metadata\":{\"message_id\":\"IVQ_GfVT0pEoQQfMchNoVPRb4iFkZPMOarBIfk8tgUk=\",\"message_type\":\"notification\",\"message_timestamp\":\"2024-05-22T21:13:38.648260688Z\",\"subscription_type\":\"channel.chat.message\",\"subscription_version\":\"1\"},\"payload\":{\"subscription\":{\"id\":\"79510867-8a4e-439c-a6ff-f06a61b1db1d\",\"status\":\"enabled\",\"type\":\"channel.chat.message\",\"version\":\"1\",\"condition\":{\"broadcaster_user_id\":\"908818451\",\"user_id\":\"55056264\"},\"transport\":{\"method\":\"conduit\",\"conduit_id\":\"896f2a0e-5ba9-430c-87ff-edfca4850479\"},\"created_at\":\"2024-05-22T17:14:54.801590396Z\",\"cost\":0},\"event\":{\"broadcaster_user_id\":\"908818451\",\"broadcaster_user_login\":\"spookodey\",\"broadcaster_user_name\":\"spookodey\",\"chatter_user_id\":\"626289869\",\"chatter_user_login\":\"joemadbro29\",\"chatter_user_name\":\"joemadbro29\",\"message_id\":\"6edabda0-f621-4fcc-a548-72c6843c8ca4\",\"message\":{\"text\":\"xxiceq1Pikalove xxiceq1Pikalove xxiceq1Pikalove xxiceq1Pikalove xxiceq1Pikalove xxiceq1Pikalove\",\"fragments\":[{\"type\":\"emote\",\"text\":\"xxiceq1Pikalove\",\"cheermote\":null,\"emote\":{\"id\":\"emotesv2_e89753ce583c458192388b03c6f12d48\",\"emote_set_id\":\"98b1d4e6-22e0-4fe2-8883-ac066635ec9c\",\"owner_id\":\"489164674\",\"format\":[\"static\"]},\"mention\":null},{\"type\":\"text\",\"text\":\" \",\"cheermote\":null,\"emote\":null,\"mention\":null},{\"type\":\"emote\",\"text\":\"xxiceq1Pikalove\",\"cheermote\":null,\"emote\":{\"id\":\"emotesv2_e89753ce583c458192388b03c6f12d48\",\"emote_set_id\":\"98b1d4e6-22e0-4fe2-8883-ac066635ec9c\",\"owner_id\":\"489164674\",\"format\":[\"static\"]},\"mention\":null},{\"type\":\"text\",\"text\":\" \",\"cheermote\":null,\"emote\":null,\"mention\":null},{\"type\":\"emote\",\"text\":\"xxiceq1Pikalove\",\"cheermote\":null,\"emote\":{\"id\":\"emotesv2_e89753ce583c458192388b03c6f12d48\",\"emote_set_id\":\"98b1d4e6-22e0-4fe2-8883-ac066635ec9c\",\"owner_id\":\"489164674\",\"format\":[\"static\"]},\"mention\":null},{\"type\":\"text\",\"text\":\" \",\"cheermote\":null,\"emote\":null,\"mention\":null},{\"type\":\"emote\",\"text\":\"xxiceq1Pikalove\",\"cheermote\":null,\"emote\":{\"id\":\"emotesv2_e89753ce583c458192388b03c6f12d48\",\"emote_set_id\":\"98b1d4e6-22e0-4fe2-8883-ac066635ec9c\",\"owner_id\":\"489164674\",\"format\":[\"static\"]},\"mention\":null},{\"type\":\"text\",\"text\":\" \",\"cheermote\":null,\"emote\":null,\"mention\":null},{\"type\":\"emote\",\"text\":\"xxiceq1Pikalove\",\"cheermote\":null,\"emote\":{\"id\":\"emotesv2_e89753ce583c458192388b03c6f12d48\",\"emote_set_id\":\"98b1d4e6-22e0-4fe2-8883-ac066635ec9c\",\"owner_id\":\"489164674\",\"format\":[\"static\"]},\"mention\":null},{\"type\":\"text\",\"text\":\" \",\"cheermote\":null,\"emote\":null,\"mention\":null},{\"type\":\"emote\",\"text\":\"xxiceq1Pikalove\",\"cheermote\":null,\"emote\":{\"id\":\"emotesv2_e89753ce583c458192388b03c6f12d48\",\"emote_set_id\":\"98b1d4e6-22e0-4fe2-8883-ac066635ec9c\",\"owner_id\":\"489164674\",\"format\":[\"static\"]},\"mention\":null}]},\"color\":\"#008000\",\"badges\":[{\"set_id\":\"twitch-recap-2023\",\"id\":\"1\",\"info\":\"\"}],\"message_type\":\"text\",\"cheer\":null,\"reply\":null,\"channel_points_custom_reward_id\":null,\"channel_points_animation_id\":null}}}", //nolint:dupword
		"{\"metadata\":{\"message_id\":\"R7ko0tXovXxZchNKB22ZsUK9qRfkesGBP7aSlDZ_Bwo=\",\"message_type\":\"notification\",\"message_timestamp\":\"2024-05-22T21:08:48.74093428Z\",\"subscription_type\":\"channel.chat.message\",\"subscription_version\":\"1\"},\"payload\":{\"subscription\":{\"id\":\"073c30f8-dffc-4e90-a140-689cfa1cac43\",\"status\":\"enabled\",\"type\":\"channel.chat.message\",\"version\":\"1\",\"condition\":{\"broadcaster_user_id\":\"39392583\",\"user_id\":\"55056264\"},\"transport\":{\"method\":\"conduit\",\"conduit_id\":\"896f2a0e-5ba9-430c-87ff-edfca4850479\"},\"created_at\":\"2024-05-22T17:15:00.633267495Z\",\"cost\":0},\"event\":{\"broadcaster_user_id\":\"39392583\",\"broadcaster_user_login\":\"ryuquezacotl\",\"broadcaster_user_name\":\"RyuQuezacotl\",\"chatter_user_id\":\"55799014\",\"chatter_user_login\":\"r0gerthat\",\"chatter_user_name\":\"r0gerthat\",\"message_id\":\"146373ab-b18f-4533-b563-11d1986245e4\",\"message\":{\"text\":\"ruyuLOVE\",\"fragments\":[{\"type\":\"emote\",\"text\":\"ruyuLOVE\",\"cheermote\":null,\"emote\":{\"id\":\"emotesv2_935e202e52d54509979ae64d71da9e0a\",\"emote_set_id\":\"eef7137f-1a30-4631-96a4-d07d4b6627a0\",\"owner_id\":\"39392583\",\"format\":[\"static\"]},\"mention\":null}]},\"color\":\"#D9A520\",\"badges\":[{\"set_id\":\"subscriber\",\"id\":\"48\",\"info\":\"53\"},{\"set_id\":\"premium\",\"id\":\"1\",\"info\":\"\"}],\"message_type\":\"text\",\"cheer\":null,\"reply\":null,\"channel_points_custom_reward_id\":null,\"channel_points_animation_id\":null}}}",
		"{\"metadata\":{\"message_id\":\"u15U_B7wpuTOHEY3PtehD5XGwUqQIHWctJb4RkyedWY=\",\"message_type\":\"notification\",\"message_timestamp\":\"2024-05-22T21:33:31.153822263Z\",\"subscription_type\":\"channel.chat.message\",\"subscription_version\":\"1\"},\"payload\":{\"subscription\":{\"id\":\"5c32f8d4-163d-4200-bfff-043b55a5ef9c\",\"status\":\"enabled\",\"type\":\"channel.chat.message\",\"version\":\"1\",\"condition\":{\"broadcaster_user_id\":\"22186976\",\"user_id\":\"55056264\"},\"transport\":{\"method\":\"conduit\",\"conduit_id\":\"896f2a0e-5ba9-430c-87ff-edfca4850479\"},\"created_at\":\"2024-05-22T17:14:35.330453713Z\",\"cost\":0},\"event\":{\"broadcaster_user_id\":\"22186976\",\"broadcaster_user_login\":\"hcjustin\",\"broadcaster_user_name\":\"HCJustin\",\"chatter_user_id\":\"28087971\",\"chatter_user_login\":\"perrymcguire\",\"chatter_user_name\":\"perrymcguire\",\"message_id\":\"7e5bc6f7-bdf0-490f-816e-d542b3d4646f\",\"message\":{\"text\":\"i do cycling for cardio so step count means nothing :/\",\"fragments\":[{\"type\":\"text\",\"text\":\"i do cycling for cardio so step count means nothing \",\"cheermote\":null,\"emote\":null,\"mention\":null},{\"type\":\"emote\",\"text\":\":/\",\"cheermote\":null,\"emote\":{\"id\":\"555555585\",\"emote_set_id\":\"0\",\"owner_id\":\"twitch\",\"format\":[\"static\"]},\"mention\":null}]},\"color\":\"\",\"badges\":[{\"set_id\":\"premium\",\"id\":\"1\",\"info\":\"\"}],\"message_type\":\"text\",\"cheer\":null,\"reply\":null,\"channel_points_custom_reward_id\":null,\"channel_points_animation_id\":null}}}",
	}

	for i, raw := range tests {
		t.Run(strconv.Itoa(i), func(t *testing.T) {
			t.Parallel()
			var msg eventsub.WebsocketMessage
			err := json.Unmarshal([]byte(raw), &msg)
			assert.NilError(t, err)
		})
	}
}
